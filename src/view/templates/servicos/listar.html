{% extends "base.html" %} {% block title %}Serviços - PetShop ERP{% endblock %}
{% block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
>
  <h1 class="h2">
    <span
      class="material-symbols-outlined me-2"
      style="
        color: var(--primary-color);
        font-size: 2rem;
        vertical-align: middle;
      "
      >design_services</span
    >
    Gerenciar Serviços
  </h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a href="{{ url_for('servico_views.novo') }}" class="btn btn-primary">
      <span class="material-symbols-outlined me-1">add</span> Novo Serviço
    </a>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <div class="input-group">
      <span class="input-group-text">
        <span class="material-symbols-outlined">search</span>
      </span>
      <input
        type="text"
        id="searchInput"
        class="form-control"
        placeholder="Buscar por nome ou categoria..."
      />
    </div>
  </div>
  <div class="col-md-3">
    <select id="categoriaFilter" class="form-select">
      <option value="">Todas as categorias</option>
      <option value="Banho">Banho</option>
      <option value="Tosa">Tosa</option>
      <option value="Consulta">Consulta</option>
      <option value="Cirurgia">Cirurgia</option>
      <option value="Vacinação">Vacinação</option>
      <option value="Outros">Outros</option>
    </select>
  </div>
  <div class="col-md-3">
    <select id="statusFilter" class="form-select">
      <option value="">Todos os status</option>
      <option value="true">Ativos</option>
      <option value="false">Inativos</option>
    </select>
  </div>
</div>

<div class="card">
  <div class="card-body">
    {% if servicos %}
    <div class="table-responsive">
      <table class="table table-striped table-hover" id="servicosTable">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Categoria</th>
            <th>Preço</th>
            <th>Duração</th>
            <th>Cadastro</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for servico in servicos %}
          <tr>
            <td>{{ servico.id }}</td>
            <td>
              <div class="d-flex align-items-center">
                <span
                  class="material-symbols-outlined me-2"
                  style="color: var(--ctp-sapphire)"
                  >design_services</span
                >
                <strong>{{ servico.nome }}</strong>
              </div>
            </td>
            <td>
              <span class="badge bg-info">{{ servico.categoria }}</span>
            </td>
            <td>
              <strong style="color: var(--ctp-green)"
                >R$ {{ "%.2f"|format(servico.preco) }}</strong
              >
            </td>
            <td>
              {% if servico.duracao_estimada %}
              <span
                class="material-symbols-outlined me-1"
                style="font-size: 16px; color: var(--ctp-yellow)"
                >schedule</span
              >
              {{ servico.duracao_estimada }} min {% else %}
              <span class="text-muted">Não informado</span>
              {% endif %}
            </td>
            <td>
              <small class="text-muted"
                >{{ servico.data_cadastro.strftime('%d/%m/%Y') if
                servico.data_cadastro else 'N/A' }}</small
              >
            </td>
            <td>
              {% if servico.ativo %}
              <span class="badge bg-success">Ativo</span>
              {% else %}
              <span class="badge bg-danger">Inativo</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group" role="group">
                <a
                  href="{{ url_for('servico_views.visualizar', id=servico.id) }}"
                  class="btn btn-sm btn-outline-info"
                  title="Visualizar"
                >
                  <span class="material-symbols-outlined">visibility</span>
                </a>
                <a
                  href="{{ url_for('servico_views.editar', id=servico.id) }}"
                  class="btn btn-sm btn-outline-warning"
                  title="Editar"
                >
                  <span class="material-symbols-outlined">edit</span>
                </a>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  onclick="confirmarExclusao({{ servico.id }}, '{{ servico.nome }}')"
                  title="Excluir"
                >
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    {% if pagination and pagination.pages > 1 %}
    <nav aria-label="Navegação de páginas" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
          <a
            class="page-link"
            href="{{ url_for('servico_views.listar', page=pagination.prev_num) }}"
          >
            <span class="material-symbols-outlined">chevron_left</span>
          </a>
        </li>
        {% endif %} {% for page_num in range(1, pagination.pages + 1) %} {% if
        page_num != pagination.page %}
        <li class="page-item">
          <a
            class="page-link"
            href="{{ url_for('servico_views.listar', page=page_num) }}"
            >{{ page_num }}</a
          >
        </li>
        {% else %}
        <li class="page-item active">
          <span class="page-link">{{ page_num }}</span>
        </li>
        {% endif %} {% endfor %} {% if pagination.has_next %}
        <li class="page-item">
          <a
            class="page-link"
            href="{{ url_for('servico_views.listar', page=pagination.next_num) }}"
          >
            <span class="material-symbols-outlined">chevron_right</span>
          </a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %} {% else %}
    <div class="text-center py-5">
      <span
        class="material-symbols-outlined mb-3"
        style="font-size: 4rem; color: var(--ctp-subtext0)"
        >design_services</span
      >
      <h5 class="text-muted">Nenhum serviço cadastrado</h5>
      <p class="text-muted mb-4">
        Comece criando o primeiro serviço da sua empresa.
      </p>
      <a href="{{ url_for('servico_views.novo') }}" class="btn btn-primary">
        <span class="material-symbols-outlined me-1">add</span> Cadastrar
        Primeiro Serviço
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Exclusão</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Tem certeza que deseja excluir o serviço
          <strong id="servicoNome"></strong>?
        </p>
        <p class="text-danger">
          <small>Esta ação não pode ser desfeita.</small>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button type="button" class="btn btn-danger" id="confirmarExclusaoBtn">
          Excluir
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let servicoIdParaExcluir = null;

  function confirmarExclusao(id, nome) {
    servicoIdParaExcluir = id;
    document.getElementById("servicoNome").textContent = nome;
    const modal = new bootstrap.Modal(
      document.getElementById("confirmDeleteModal")
    );
    modal.show();
  }

  document
    .getElementById("confirmarExclusaoBtn")
    .addEventListener("click", function () {
      if (servicoIdParaExcluir) {
        fetch(`/api/servicos/${servicoIdParaExcluir}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success || data.id) {
              window.location.reload();
            } else {
              alert(
                "Erro ao excluir serviço: " + (data.erro || "Erro desconhecido")
              );
            }
          })
          .catch((error) => {
            console.error("Erro:", error);
            alert("Erro ao excluir serviço");
          });
      }
    });

  // Busca em tempo real
  document.getElementById("searchInput").addEventListener("input", function () {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll("#servicosTable tbody tr");

    rows.forEach((row) => {
      const nome = row.cells[1].textContent.toLowerCase();
      const categoria = row.cells[2].textContent.toLowerCase();

      if (nome.includes(searchTerm) || categoria.includes(searchTerm)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  });

  // Filtro por categoria
  document
    .getElementById("categoriaFilter")
    .addEventListener("change", function () {
      const categoria = this.value.toLowerCase();
      const rows = document.querySelectorAll("#servicosTable tbody tr");

      rows.forEach((row) => {
        const rowCategoria = row.cells[2].textContent.toLowerCase();

        if (categoria === "" || rowCategoria.includes(categoria)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    });

  // Filtro por status
  document
    .getElementById("statusFilter")
    .addEventListener("change", function () {
      const status = this.value;
      const rows = document.querySelectorAll("#servicosTable tbody tr");

      rows.forEach((row) => {
        const statusText = row.cells[6].textContent.trim();
        const isAtivo = statusText === "Ativo";

        if (
          status === "" ||
          (status === "true" && isAtivo) ||
          (status === "false" && !isAtivo)
        ) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    });

  // Atalhos de teclado
  document.addEventListener("keydown", function (e) {
    if (e.ctrlKey) {
      switch (e.key) {
        case "n":
          e.preventDefault();
          window.location.href = "{{ url_for('servico_views.novo') }}";
          break;
        case "f":
          e.preventDefault();
          document.getElementById("searchInput").focus();
          break;
      }
    }
  });
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Editar Agendamento #{{ agendamento.id }} - PetShop ERP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <span class="material-symbols-outlined me-2" style="color: var(--primary-color); font-size: 2rem; vertical-align: middle;">edit_calendar</span> 
        Editar Agendamento #{{ agendamento.id }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('agendamento_views.visualizar', id=agendamento.id) }}" class="btn btn-outline-info me-2">
            <span class="material-symbols-outlined me-1">visibility</span> Visualizar
        </a>
        <a href="{{ url_for('agendamento_views.listar') }}" class="btn btn-secondary">
            <span class="material-symbols-outlined me-1">arrow_back</span> Voltar
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <span class="material-symbols-outlined me-2">edit_calendar</span>
                <strong>{{ agendamento.cliente.nome if agendamento.cliente else 'Cliente' }} - {{ agendamento.data_agendamento.strftime('%d/%m/%Y %H:%M') }}</strong>
                {% set status_class = {
                    'Agendado': 'bg-info',
                    'Confirmado': 'bg-primary', 
                    'Em Andamento': 'bg-warning',
                    'Concluído': 'bg-success',
                    'Cancelado': 'bg-danger'
                } %}
                <span class="badge {{ status_class.get(agendamento.status, 'bg-secondary') }} ms-auto">
                    {{ agendamento.status }}
                </span>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('agendamento_views.atualizar', id=agendamento.id) }}" id="agendamentoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente_id" class="form-label">Cliente <span class="text-danger">*</span></label>
                                <select class="form-select" id="cliente_id" name="cliente_id" required>
                                    <option value="">Selecione um cliente</option>
                                    {% for cliente in clientes %}
                                        {% if cliente.ativo %}
                                        <option value="{{ cliente.id }}" {% if agendamento.cliente_id == cliente.id %}selected{% endif %}>
                                            {{ cliente.nome }} - {{ cliente.telefone }}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback" id="cliente_id-error"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="servico_id" class="form-label">Serviço <span class="text-danger">*</span></label>
                                <select class="form-select" id="servico_id" name="servico_id" required>
                                    <option value="">Selecione um serviço</option>
                                    {% for servico in servicos %}
                                        {% if servico.ativo %}
                                        <option value="{{ servico.id }}" 
                                                data-preco="{{ servico.preco }}" 
                                                data-duracao="{{ servico.duracao_estimada or '' }}"
                                                {% if agendamento.servico_id == servico.id %}selected{% endif %}>
                                            {{ servico.nome }} - R$ {{ "%.2f"|format(servico.preco) }}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback" id="servico_id-error"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data_agendamento" class="form-label">Data e Hora <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="data_agendamento" name="data_agendamento" 
                                       value="{{ agendamento.data_agendamento.strftime('%Y-%m-%dT%H:%M') }}" required>
                                <div class="invalid-feedback" id="data_agendamento-error"></div>
                                <div class="form-text">
                                    <small id="datetime-support-message" style="display: none;" class="text-warning">
                                        <span class="material-symbols-outlined me-1" style="font-size: 14px;">info</span>
                                        Seu navegador pode não suportar seleção de hora. Use o formato: YYYY-MM-DD HH:MM
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="funcionario_id" class="form-label">Funcionário</label>
                                <select class="form-select" id="funcionario_id" name="funcionario_id">
                                    <option value="">Selecione um funcionário</option>
                                    {% for funcionario in funcionarios %}
                                        {% if funcionario.ativo %}
                                        <option value="{{ funcionario.id }}" {% if agendamento.funcionario_id == funcionario.id %}selected{% endif %}>
                                            {{ funcionario.nome }} - {{ funcionario.cargo }}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div class="form-text">Opcional - pode ser deixado em branco</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="status" name="status" required>
                                    {% for status_opt in status_disponiveis %}
                                    <option value="{{ status_opt }}" {% if agendamento.status == status_opt %}selected{% endif %}>
                                        {{ status_opt }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="valor_estimado" class="form-label">Valor Estimado</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="valor_estimado" name="valor_estimado" 
                                           step="0.01" min="0" placeholder="0,00"
                                           value="{{ agendamento.valor_estimado if agendamento.valor_estimado else '' }}">
                                </div>
                                <div class="form-text">Valor estimado do serviço</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3" 
                                  placeholder="Observações adicionais sobre o agendamento...">{{ agendamento.observacoes or '' }}</textarea>
                        <div class="form-text">Informações importantes sobre o agendamento</div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="resetarFormulario()">
                            <span class="material-symbols-outlined me-1">refresh</span> Resetar
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="visualizarAgendamento()">
                                <span class="material-symbols-outlined me-1">visibility</span> Visualizar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <span class="material-symbols-outlined me-1">save</span> Salvar Alterações
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Estatísticas Gerais -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">analytics</span>
                    Estatísticas Gerais
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="card border-primary">
                            <div class="card-body text-center p-2">
                                <div class="text-primary h4 mb-0">{{ estatisticas.total }}</div>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card border-info">
                            <div class="card-body text-center p-2">
                                <div class="text-info h4 mb-0">{{ estatisticas.hoje }}</div>
                                <small class="text-muted">Hoje</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card border-success">
                            <div class="card-body text-center p-2">
                                <div class="text-success h4 mb-0">{{ estatisticas.concluidos }}</div>
                                <small class="text-muted">Concluídos</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card border-warning">
                            <div class="card-body text-center p-2">
                                <div class="text-warning h4 mb-0">{{ estatisticas.em_andamento }}</div>
                                <small class="text-muted">Em Andamento</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumo das Alterações -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">summarize</span>
                    Resumo do Agendamento
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">Cliente:</small>
                    <div id="cliente-resumo" class="fw-bold">{{ agendamento.cliente.nome if agendamento.cliente else 'N/A' }}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Serviço:</small>
                    <div id="servico-resumo" class="fw-bold">{{ agendamento.servico.nome if agendamento.servico else 'N/A' }}</div>
                    <div id="servico-preco" class="text-success">R$ {{ "%.2f"|format(agendamento.servico.preco) if agendamento.servico else '0,00' }}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Data e Hora:</small>
                    <div id="data-resumo" class="fw-bold">{{ agendamento.data_agendamento.strftime('%d/%m/%Y %H:%M') }}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Funcionário:</small>
                    <div id="funcionario-resumo" class="fw-bold">{{ agendamento.funcionario.nome if agendamento.funcionario else 'Não atribuído' }}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Status:</small>
                    <div id="status-resumo" class="fw-bold">{{ agendamento.status }}</div>
                </div>
                <hr>
                <div class="mb-0">
                    <small class="text-muted">Valor Total:</small>
                    <div id="valor-total" class="h5 text-success mb-0">R$ {{ "%.2f"|format(agendamento.valor_estimado) if agendamento.valor_estimado else '0,00' }}</div>
                </div>
            </div>
        </div>

        <!-- Histórico do Agendamento -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">history</span>
                    Informações do Agendamento
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <small class="text-muted">ID do Agendamento:</small>
                    <div class="fw-bold">#{{ agendamento.id }}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Criado em:</small>
                    <div>{{ agendamento.data_criacao.strftime('%d/%m/%Y %H:%M') }}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Status Atual:</small>
                    {% set status_class = {
                        'Agendado': 'text-info',
                        'Confirmado': 'text-primary', 
                        'Em Andamento': 'text-warning',
                        'Concluído': 'text-success',
                        'Cancelado': 'text-danger'
                    } %}
                    <div class="{{ status_class.get(agendamento.status, 'text-secondary') }} fw-bold">{{ agendamento.status }}</div>
                </div>
                {% if agendamento.tempo_estimado %}
                <div class="mb-0">
                    <small class="text-muted">Duração Estimada:</small>
                    <div>{{ agendamento.tempo_estimado }} minutos</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Dicas -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">lightbulb</span>
                    Dicas de Edição
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <span class="material-symbols-outlined text-primary me-2" style="font-size: 1rem;">edit</span>
                        <small>Altere apenas os campos necessários</small>
                    </li>
                    <li class="mb-2">
                        <span class="material-symbols-outlined text-primary me-2" style="font-size: 1rem;">schedule</span>
                        <small>Data deve ser futura se status for Agendado</small>
                    </li>
                    <li class="mb-2">
                        <span class="material-symbols-outlined text-primary me-2" style="font-size: 1rem;">person_check</span>
                        <small>Funcionário pode ser alterado a qualquer momento</small>
                    </li>
                    <li class="mb-0">
                        <span class="material-symbols-outlined text-primary me-2" style="font-size: 1rem;">payments</span>
                        <small>Valor será atualizado com base no serviço</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar suporte a datetime-local (especialmente no Firefox)
    verificarSuporteDatetime();

    // Configurar data mínima para hoje apenas se status for Agendado
    const dataInput = document.getElementById('data_agendamento');
    const statusSelect = document.getElementById('status');
    
    function atualizarDataMinima() {
        if (statusSelect.value === 'Agendado') {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            dataInput.min = now.toISOString().slice(0, 16);
        } else {
            dataInput.removeAttribute('min');
        }
    }
    
    atualizarDataMinima();
    statusSelect.addEventListener('change', atualizarDataMinima);

    // Atualizar resumo em tempo real
    const clienteSelect = document.getElementById('cliente_id');
    const servicoSelect = document.getElementById('servico_id');
    const funcionarioSelect = document.getElementById('funcionario_id');
    const valorInput = document.getElementById('valor_estimado');

    clienteSelect.addEventListener('change', atualizarResumo);
    servicoSelect.addEventListener('change', function() {
        atualizarResumo();
        atualizarValorEstimado();
    });
    funcionarioSelect.addEventListener('change', atualizarResumo);
    dataInput.addEventListener('change', atualizarResumo);
    statusSelect.addEventListener('change', atualizarResumo);
    valorInput.addEventListener('input', atualizarResumo);

    // Validação em tempo real
    const form = document.getElementById('agendamentoForm');
    form.addEventListener('submit', function(e) {
        if (!validarFormulario()) {
            e.preventDefault();
        }
    });
});

function atualizarResumo() {
    const clienteSelect = document.getElementById('cliente_id');
    const servicoSelect = document.getElementById('servico_id');
    const funcionarioSelect = document.getElementById('funcionario_id');
    const dataInput = document.getElementById('data_agendamento');
    const statusSelect = document.getElementById('status');
    const valorInput = document.getElementById('valor_estimado');

    // Cliente
    const clienteResumo = document.getElementById('cliente-resumo');
    clienteResumo.textContent = clienteSelect.selectedOptions[0]?.text.split(' - ')[0] || 'Nenhum cliente selecionado';

    // Serviço
    const servicoResumo = document.getElementById('servico-resumo');
    const servicoPreco = document.getElementById('servico-preco');
    if (servicoSelect.value) {
        const servicoOption = servicoSelect.selectedOptions[0];
        servicoResumo.textContent = servicoOption.text.split(' - ')[0];
        const preco = servicoOption.dataset.preco;
        servicoPreco.textContent = `R$ ${parseFloat(preco).toFixed(2)}`;
    } else {
        servicoResumo.textContent = 'Nenhum serviço selecionado';
        servicoPreco.textContent = '';
    }

    // Funcionário
    const funcionarioResumo = document.getElementById('funcionario-resumo');
    funcionarioResumo.textContent = funcionarioSelect.selectedOptions[0]?.text.split(' - ')[0] || 'Não atribuído';

    // Data
    const dataResumo = document.getElementById('data-resumo');
    if (dataInput.value) {
        const data = new Date(dataInput.value);
        dataResumo.textContent = data.toLocaleString('pt-BR');
    } else {
        dataResumo.textContent = 'Não definida';
    }

    // Status
    const statusResumo = document.getElementById('status-resumo');
    statusResumo.textContent = statusSelect.value;

    // Valor total
    const valorTotal = document.getElementById('valor-total');
    const valor = valorInput.value || (servicoSelect.selectedOptions[0]?.dataset.preco || 0);
    valorTotal.textContent = `R$ ${parseFloat(valor).toFixed(2)}`;
}

function verificarSuporteDatetime() {
    const input = document.createElement('input');
    input.type = 'datetime-local';
    input.value = 'not-a-date';
    
    // Se o navegador não suporta datetime-local, o valor permanece
    if (input.value === 'not-a-date') {
        document.getElementById('datetime-support-message').style.display = 'block';
        
        // Adicionar placeholder para ajudar o usuário
        const dataInput = document.getElementById('data_agendamento');
        dataInput.placeholder = 'YYYY-MM-DDTHH:MM';
        dataInput.setAttribute('pattern', '[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}');
        dataInput.setAttribute('title', 'Formato: YYYY-MM-DD HH:MM (exemplo: 2025-09-15T14:30)');
    }
}

function atualizarValorEstimado() {
    const servicoSelect = document.getElementById('servico_id');
    const valorInput = document.getElementById('valor_estimado');
    
    if (servicoSelect.value) {
        const preco = servicoSelect.selectedOptions[0].dataset.preco;
        const precoFormatado = parseFloat(preco).toFixed(2);
        
        // Se o campo estava vazio ou continha o valor de outro serviço, atualizar
        if (!valorInput.value || valorInput.dataset.fromService) {
            valorInput.value = precoFormatado;
            valorInput.dataset.fromService = 'true';
            
            // Adicionar feedback visual temporário
            valorInput.classList.add('border-success');
            setTimeout(() => {
                valorInput.classList.remove('border-success');
            }, 2000);
        }
        // Se o usuário já digitou um valor personalizado, manter o valor atual
        // mas mostrar uma dica visual
        else if (valorInput.value !== precoFormatado) {
            const parentDiv = valorInput.closest('.input-group').parentElement;
            let suggestao = parentDiv.querySelector('.price-suggestion');
            
            if (!suggestao) {
                suggestao = document.createElement('div');
                suggestao.className = 'price-suggestion form-text text-info mt-1';
                suggestao.innerHTML = `<small><span class="material-symbols-outlined me-1" style="font-size: 12px;">lightbulb</span>Valor sugerido pelo serviço: R$ ${precoFormatado}</small>`;
                parentDiv.appendChild(suggestao);
                
                // Remover sugestão após 5 segundos
                setTimeout(() => {
                    if (suggestao.parentElement) {
                        suggestao.remove();
                    }
                }, 5000);
            }
        }
    } else {
        // Limpar valor se nenhum serviço selecionado
        if (valorInput.dataset.fromService) {
            valorInput.value = '';
            delete valorInput.dataset.fromService;
        }
    }
}

function validarFormulario() {
    let valido = true;
    
    // Validar cliente
    const clienteSelect = document.getElementById('cliente_id');
    if (!clienteSelect.value) {
        mostrarErro('cliente_id', 'Por favor, selecione um cliente');
        valido = false;
    } else {
        limparErro('cliente_id');
    }

    // Validar serviço
    const servicoSelect = document.getElementById('servico_id');
    if (!servicoSelect.value) {
        mostrarErro('servico_id', 'Por favor, selecione um serviço');
        valido = false;
    } else {
        limparErro('servico_id');
    }

    // Validar data
    const dataInput = document.getElementById('data_agendamento');
    const statusSelect = document.getElementById('status');
    if (!dataInput.value) {
        mostrarErro('data_agendamento', 'Por favor, selecione uma data e hora');
        valido = false;
    } else if (statusSelect.value === 'Agendado' && new Date(dataInput.value) < new Date()) {
        mostrarErro('data_agendamento', 'A data deve ser futura para agendamentos');
        valido = false;
    } else {
        limparErro('data_agendamento');
    }

    return valido;
}

function mostrarErro(campo, mensagem) {
    const input = document.getElementById(campo);
    const errorDiv = document.getElementById(campo + '-error');
    input.classList.add('is-invalid');
    errorDiv.textContent = mensagem;
}

function limparErro(campo) {
    const input = document.getElementById(campo);
    const errorDiv = document.getElementById(campo + '-error');
    input.classList.remove('is-invalid');
    errorDiv.textContent = '';
}

function resetarFormulario() {
    if (confirm('Tem certeza que deseja resetar todos os campos para os valores originais?')) {
        location.reload();
    }
}

function visualizarAgendamento() {
    window.location.href = "{{ url_for('agendamento_views.visualizar', id=agendamento.id) }}";
}

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 's':
                e.preventDefault();
                document.getElementById('agendamentoForm').submit();
                break;
            case 'r':
                e.preventDefault();
                resetarFormulario();
                break;
        }
    }
    if (e.key === 'Escape') {
        window.location.href = "{{ url_for('agendamento_views.listar') }}";
    }
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Funcionário {{ funcionario.nome }} - PetShop ERP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <span class="material-symbols-outlined me-2" style="color: var(--primary-color); font-size: 2rem; vertical-align: middle;">badge</span> 
        {{ funcionario.nome }}
        {% if not funcionario.ativo %}
            <span class="badge bg-danger ms-2">Inativo</span>
        {% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('funcionario_views.editar_funcionario', funcionario_id=funcionario.id) }}" class="btn btn-warning">
                <span class="material-symbols-outlined me-1">edit</span> Editar
            </a>
            {% if funcionario.ativo %}
            <button onclick="confirmarDesativacao()" class="btn btn-danger">
                <span class="material-symbols-outlined me-1">close</span> Desativar
            </button>
            {% else %}
            <button onclick="ativarFuncionario()" class="btn btn-success">
                <span class="material-symbols-outlined me-1">check</span> Ativar
            </button>
            {% endif %}
        </div>
        <a href="{{ url_for('funcionario_views.listar_funcionarios') }}" class="btn btn-secondary">
            <span class="material-symbols-outlined me-1">arrow_back</span> Voltar
        </a>
    </div>
</div>

<div class="row">
    <!-- Dados Pessoais -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <span class="material-symbols-outlined me-1">person</span> Dados Pessoais
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">ID:</dt>
                    <dd class="col-sm-8">{{ funcionario.id }}</dd>
                    
                    <dt class="col-sm-4">Nome:</dt>
                    <dd class="col-sm-8">{{ funcionario.nome }}</dd>
                    
                    <dt class="col-sm-4">CPF:</dt>
                    <dd class="col-sm-8">
                        <code>{{ funcionario.cpf[:3] }}.{{ funcionario.cpf[3:6] }}.{{ funcionario.cpf[6:9] }}-{{ funcionario.cpf[9:] }}</code>
                    </dd>
                    
                    <dt class="col-sm-4">Telefone:</dt>
                    <dd class="col-sm-8">
                        {% if funcionario.telefone|length == 11 %}
                            ({{ funcionario.telefone[:2] }}) {{ funcionario.telefone[2:7] }}-{{ funcionario.telefone[7:] }}
                        {% elif funcionario.telefone|length == 10 %}
                            ({{ funcionario.telefone[:2] }}) {{ funcionario.telefone[2:6] }}-{{ funcionario.telefone[6:] }}
                        {% else %}
                            {{ funcionario.telefone }}
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Email:</dt>
                    <dd class="col-sm-8">
                        {% if funcionario.email %}
                            <a href="mailto:{{ funcionario.email }}">{{ funcionario.email }}</a>
                        {% else %}
                            <span class="text-muted">Não informado</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Endereço:</dt>
                    <dd class="col-sm-8">
                        {% if funcionario.endereco %}
                            {{ funcionario.endereco }}
                        {% else %}
                            <span class="text-muted">Não informado</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Cadastro:</dt>
                    <dd class="col-sm-8">
                        {{ funcionario.data_cadastro.strftime('%d/%m/%Y às %H:%M') if funcionario.data_cadastro else 'N/A' }}
                    </dd>
                    
                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                        {% if funcionario.ativo %}
                            <span class="badge bg-success">Ativo</span>
                        {% else %}
                            <span class="badge bg-danger">Inativo</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>
    </div>

    <!-- Dados Profissionais -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <span class="material-symbols-outlined me-1">work</span> Dados Profissionais
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Cargo:</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-info fs-6">{{ funcionario.cargo }}</span>
                    </dd>
                    
                    <dt class="col-sm-4">Salário:</dt>
                    <dd class="col-sm-8">
                        {% if funcionario.salario %}
                            <strong>R$ {{ "%.2f"|format(funcionario.salario) }}</strong>
                        {% else %}
                            <span class="text-muted">Não informado</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Admissão:</dt>
                    <dd class="col-sm-8">
                        {{ funcionario.data_admissao.strftime('%d/%m/%Y') if funcionario.data_admissao else 'N/A' }}
                        {% if funcionario.data_admissao %}
                            {% set dias_empresa = (moment().date() - funcionario.data_admissao).days %}
                            <br><small class="text-muted">{{ dias_empresa }} dias na empresa</small>
                        {% endif %}
                    </dd>
                    
                    {% if funcionario.data_demissao %}
                    <dt class="col-sm-4">Demissão:</dt>
                    <dd class="col-sm-8">
                        <span class="text-danger">{{ funcionario.data_demissao.strftime('%d/%m/%Y') }}</span>
                    </dd>
                    {% endif %}
                </dl>

                <!-- Estatísticas -->
                <div class="row text-center mt-4">
                    <div class="col-md-6">
                        <div class="card card-stat text-white" style="background: var(--ctp-surface1); border-left: 4px solid var(--ctp-pink);">
                            <div class="card-body">
                                <span class="material-symbols-outlined mb-2" style="font-size: 2rem;">sell</span>
                                <h3>{{ funcionario.vendas|length }}</h3>
                                <p>Vendas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-stat text-white" style="background: var(--ctp-surface1); border-left: 4px solid var(--ctp-blue);">
                            <div class="card-body">
                                <span class="material-symbols-outlined mb-2" style="font-size: 2rem;">calendar_month</span>
                                <h3>{{ funcionario.agendamentos|length }}</h3>
                                <p>Agendamentos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <span class="material-symbols-outlined me-1">bolt</span> Ações Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/vendas/nova?funcionario_id={{ funcionario.id }}" class="btn btn-primary">
                        <span class="material-symbols-outlined me-1">sell</span> Nova Venda
                    </a>
                    <a href="/agendamentos/novo?funcionario_id={{ funcionario.id }}" class="btn btn-info">
                        <span class="material-symbols-outlined me-1">calendar_add</span> Novo Agendamento
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Histórico de Vendas -->
{% if funcionario.vendas %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <span class="material-symbols-outlined me-1">sell</span> Histórico de Vendas
                </h5>
                <a href="/vendas?funcionario_id={{ funcionario.id }}" class="btn btn-sm btn-outline-primary">
                    Ver Todas
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venda in funcionario.vendas[-5:] %}
                            <tr>
                                <td>#{{ venda.id }}</td>
                                <td>{{ venda.cliente.nome if venda.cliente else '-' }}</td>
                                <td>{{ venda.data_venda.strftime('%d/%m/%Y') if venda.data_venda else '-' }}</td>
                                <td>R$ {{ "%.2f"|format(venda.total or 0) }}</td>
                                <td>
                                    <span class="badge bg-success">Concluída</span>
                                </td>
                                <td>
                                    <a href="/vendas/{{ venda.id }}" class="btn btn-sm btn-outline-info">
                                        <span class="material-symbols-outlined">visibility</span>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if funcionario.vendas|length > 5 %}
                <div class="text-center mt-2">
                    <small class="text-muted">Mostrando as 5 vendas mais recentes</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Histórico de Agendamentos -->
{% if funcionario.agendamentos %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <span class="material-symbols-outlined me-1">calendar_month</span> Agendamentos Recentes
                </h5>
                <a href="/agendamentos?funcionario_id={{ funcionario.id }}" class="btn btn-sm btn-outline-primary">
                    Ver Todos
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Pet</th>
                                <th>Serviço</th>
                                <th>Data/Hora</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for agendamento in funcionario.agendamentos[-5:] %}
                            <tr>
                                <td>#{{ agendamento.id }}</td>
                                <td>{{ agendamento.cliente.nome if agendamento.cliente else '-' }}</td>
                                <td>{{ agendamento.pet.nome if agendamento.pet else '-' }}</td>
                                <td>{{ agendamento.servico.nome if agendamento.servico else '-' }}</td>
                                <td>
                                    {% if agendamento.data_agendamento %}
                                        {{ agendamento.data_agendamento.strftime('%d/%m/%Y') }}
                                        {% if agendamento.hora_agendamento %}
                                            às {{ agendamento.hora_agendamento.strftime('%H:%M') }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if agendamento.status == 'agendado' %}
                                        <span class="badge bg-warning">Agendado</span>
                                    {% elif agendamento.status == 'concluido' %}
                                        <span class="badge bg-success">Concluído</span>
                                    {% elif agendamento.status == 'cancelado' %}
                                        <span class="badge bg-danger">Cancelado</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ agendamento.status or 'N/A' }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/agendamentos/{{ agendamento.id }}" class="btn btn-sm btn-outline-info">
                                        <span class="material-symbols-outlined">visibility</span>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if funcionario.agendamentos|length > 5 %}
                <div class="text-center mt-2">
                    <small class="text-muted">Mostrando os 5 agendamentos mais recentes</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de confirmação -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmMessage">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmAction">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmarDesativacao() {
    document.getElementById('confirmMessage').innerHTML = 
        `Tem certeza que deseja desativar o funcionário <strong>{{ funcionario.nome }}</strong>?<br>
         <small class="text-muted">Esta ação pode ser revertida posteriormente.</small>`;
    
    document.getElementById('confirmAction').onclick = function() {
        desativarFuncionario();
    };
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

function desativarFuncionario() {
    fetch('/api/funcionarios/{{ funcionario.id }}', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.mensagem) {
            location.reload();
        } else {
            alert('Erro ao desativar funcionário: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao desativar funcionário');
    });
}

function ativarFuncionario() {
    fetch('/api/funcionarios/{{ funcionario.id }}/ativar', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            location.reload();
        } else {
            alert('Erro ao ativar funcionário: ' + (data.erro || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao ativar funcionário');
    });
}
</script>
{% endblock %}